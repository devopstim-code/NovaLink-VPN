name: NovaLink Security CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            valgrind \
            iproute2

      - name: Install liboqs (Post-Quantum Library)
        run: |
          git clone --depth 1-b 0.10.0 https://github.com/open-quantum-safe/liboqs.git
          cmake -S liboqs -B liboqs/build -DBUILD_SHARED_LIBS=ON
          sudo cmake --build liboqs/build --target install
          sudo ldconfig

      - name: Configure and Build NovaLink
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          cmake --build build -j$(nproc)

      - name: Run Memory Leak Analysis (Valgrind)
        run: |
          sudo ip tuntap add mode tun nova_srv || true
          sudo ip addr add 10.0.0.1/24 dev nova_srv || true
          sudo ip link set dev nova_srv up
          sudo timeout --preserve-status 15s valgrind \
            --leak-check=full \
            --show-leak-kinds=all \
            --track-origins=yes \
            --error-exitcode=1 \
            ./build/bin/nova_srv 0.0.0.0 4433 10.0.0.1 || {
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 1 ]; then
                echo "MEMORY LEAK DETECTED"
                exit 1
              fi
              echo "Memory analysis completed successfully"
              exit 0
            }

      - name: SonarCloud Scan
        if: success()
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}